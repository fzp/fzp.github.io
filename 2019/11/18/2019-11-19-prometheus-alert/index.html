<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Prometheus 告警"><meta name="keywords" content="alert,Prometheus"><meta name="author" content="方镇澎"><meta name="copyright" content="方镇澎"><title>Prometheus 告警 | 方镇澎的博客</title><link rel="shortcut icon" href="/favicon.svg"><link rel="stylesheet" href="/css/index.css?version=1.9.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.3"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E8%A7%84%E5%88%99%E8%AE%A1%E7%AE%97"><span class="toc-number">2.</span> <span class="toc-text">Prometheus规则计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlertManager%E8%AD%A6%E6%8A%A5%E5%A4%84%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">AlertManager警报处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">方镇澎</div><div class="author-info__description text-center">方镇澎 Blog Slides</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">22</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">37</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">方镇澎的博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Prometheus 告警</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-19</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>Prometheus如何处理警报？本文以例子为导向，深入浅出地介绍Prometheus的告警配置。</p>
<a id="more"></a>

<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Prometheus服务器本身并不处理告警信。他将告警管理模块AlertManger单独了出来。</p>
<p>因此，Prometheus的告警分成两步，首先由Prometheus服务器定时根据告警规则进行计算。如果生成警报（akert）, 就推送到AlertManager处理。AlertManager会管理警报，将它们分组，去重，路由到对应的接收者等。</p>
<h2 id="Prometheus规则计算"><a href="#Prometheus规则计算" class="headerlink" title="Prometheus规则计算"></a>Prometheus规则计算</h2><p>在Prometheus的配置文件下添加用于警报的规则文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;/etc/prometheus/alertmanager.rules&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>alertmanager.rules</code>是我们自己创建的文件。下面是官方文档的一个例子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Alert for any instance that is unreachable for &gt;5 minutes.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">InstanceDown</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 5 minutes.&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Alert for any instance that has a median request latency &gt;1s.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">APIHighRequestLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">api_http_request_latencies_second&#123;quantile=&quot;0.5&quot;&#125;</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High request latency on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> has a median request latency above 1s (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>s)&quot;</span></span><br></pre></td></tr></table></figure>

<p>alert是按照group来组织的，每一个group都由name,name后面跟着的rules,rules下是具体的alert. alert主要由下面各个部分组成：</p>
<p>表达式(expr)：Prometheus自己的PromQL表达式，比如<code>up == 0</code>是up这个metrics的值为0。</p>
<p>持续时间(for): PromQL表达式持续时间大于for指定的时间将会将会发送给alertManager.</p>
<p>标签(labels):给alert的标签，可用于后续alertManager的管理或发送给接收者。</p>
<p>注释（annotations):对alert的描述。</p>
<p>标签和注释不是一般的字符串,它是Go语言的模板语言，可以在字符串中添加<code>&#123;&#123;&#125;&#125;</code>插入变量。常见的变量有<code>$labels</code>，它是表达式中的标签。还有<code>$value</code>，它是表达式的值。</p>
<p>alert的生命周期分为3个状态:</p>
<ol>
<li>inactive: expr为假</li>
<li>pending: expr为真但未达到for要求的时间</li>
<li>firing: expr为真且达到for要求的时间</li>
</ol>
<h2 id="AlertManager警报处理"><a href="#AlertManager警报处理" class="headerlink" title="AlertManager警报处理"></a>AlertManager警报处理</h2><p>AlertManager是一个单独的模块，它有自己的配置文件。下面是一个官方例子。来自<a target="_blank" rel="noopener" href="https://github.com/prometheus/alertmanager/blob/master/doc/examples/simple.yml">这里</a>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># The smarthost and SMTP sender used for mail notifications.</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">&#x27;localhost:25&#x27;</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">&#x27;alertmanager@example.org&#x27;</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">&#x27;alertmanager&#x27;</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">&#x27;password&#x27;</span></span><br><span class="line">  <span class="comment"># The auth token for Hipchat.</span></span><br><span class="line">  <span class="attr">hipchat_auth_token:</span> <span class="string">&#x27;1234556789&#x27;</span></span><br><span class="line">  <span class="comment"># Alternative host for Hipchat.</span></span><br><span class="line">  <span class="attr">hipchat_api_url:</span> <span class="string">&#x27;https://hipchat.foobar.org/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The directory from which notification templates are read.</span></span><br><span class="line"><span class="attr">templates:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="string">&#x27;/etc/alertmanager/template/*.tmpl&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The root route on which each incoming alert enters.</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="comment"># The labels by which incoming alerts are grouped together. For example,</span></span><br><span class="line">  <span class="comment"># multiple alerts coming in for cluster=A and alertname=LatencyHigh would</span></span><br><span class="line">  <span class="comment"># be batched into a single group.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># To aggregate by all possible labels use &#x27;...&#x27; as the sole label name.</span></span><br><span class="line">  <span class="comment"># This effectively disables aggregation entirely, passing through all</span></span><br><span class="line">  <span class="comment"># alerts as-is. This is unlikely to be what you want, unless you have</span></span><br><span class="line">  <span class="comment"># a very low alert volume or your upstream notification system performs</span></span><br><span class="line">  <span class="comment"># its own grouping. Example: group_by: [...]</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;cluster&#x27;</span>, <span class="string">&#x27;service&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># When a new group of alerts is created by an incoming alert, wait at</span></span><br><span class="line">  <span class="comment"># least &#x27;group_wait&#x27; to send the initial notification.</span></span><br><span class="line">  <span class="comment"># This way ensures that you get multiple alerts for the same group that start</span></span><br><span class="line">  <span class="comment"># firing shortly after another are batched together on the first </span></span><br><span class="line">  <span class="comment"># notification.</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># When the first notification was sent, wait &#x27;group_interval&#x27; to send a batch</span></span><br><span class="line">  <span class="comment"># of new alerts that started firing for that group.</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If an alert has successfully been sent, wait &#x27;repeat_interval&#x27; to</span></span><br><span class="line">  <span class="comment"># resend them.</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">3h</span> </span><br><span class="line"></span><br><span class="line">  <span class="comment"># A default receiver</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">team-X-mails</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># All the above attributes are inherited by all child routes and can </span></span><br><span class="line">  <span class="comment"># overwritten on each.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The child route trees.</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">  <span class="comment"># This routes performs a regular expression match on alert labels to</span></span><br><span class="line">  <span class="comment"># catch alerts that are related to a list of services.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match_re:</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">^(foo1|foo2|baz)$</span></span><br><span class="line">    <span class="attr">receiver:</span> <span class="string">team-X-mails</span></span><br><span class="line">    <span class="comment"># The service has a sub-route for critical alerts, any alerts</span></span><br><span class="line">    <span class="comment"># that do not match, i.e. severity != critical, fall-back to the</span></span><br><span class="line">    <span class="comment"># parent node and are sent to &#x27;team-X-mails&#x27;</span></span><br><span class="line">    <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">team-X-pager</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">files</span></span><br><span class="line">    <span class="attr">receiver:</span> <span class="string">team-Y-mails</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">team-Y-pager</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># This route handles all alerts coming from a database service. If there&#x27;s</span></span><br><span class="line">  <span class="comment"># no team to handle it, it defaults to the DB team.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">database</span></span><br><span class="line">    <span class="attr">receiver:</span> <span class="string">team-DB-pager</span></span><br><span class="line">    <span class="comment"># Also group alerts by affected database.</span></span><br><span class="line">    <span class="attr">group_by:</span> [<span class="string">alertname</span>, <span class="string">cluster</span>, <span class="string">database</span>]</span><br><span class="line">    <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">team-X</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">team-X-pager</span></span><br><span class="line">      <span class="attr">continue:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">team-Y</span></span><br><span class="line">      <span class="attr">receiver:</span> <span class="string">team-Y-pager</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Inhibition rules allow to mute a set of alerts given that another alert is</span></span><br><span class="line"><span class="comment"># firing.</span></span><br><span class="line"><span class="comment"># We use this to mute any warning-level notifications if the same alert is </span></span><br><span class="line"><span class="comment"># already critical.</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">  <span class="attr">target_match:</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">  <span class="comment"># Apply inhibition if the alertname is the same.</span></span><br><span class="line">  <span class="attr">equal:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;cluster&#x27;</span>, <span class="string">&#x27;service&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;team-X-mails&#x27;</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;team-X+alerts@example.org&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;team-X-pager&#x27;</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;team-X+alerts-critical@example.org&#x27;</span></span><br><span class="line">  <span class="attr">pagerduty_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service_key:</span> <span class="string">&lt;team-X-key&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;team-Y-mails&#x27;</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;team-Y+alerts@example.org&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;team-Y-pager&#x27;</span></span><br><span class="line">  <span class="attr">pagerduty_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service_key:</span> <span class="string">&lt;team-Y-key&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;team-DB-pager&#x27;</span></span><br><span class="line">  <span class="attr">pagerduty_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service_key:</span> <span class="string">&lt;team-DB-key&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;team-X-hipchat&#x27;</span></span><br><span class="line">  <span class="attr">hipchat_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">auth_token:</span> <span class="string">&lt;auth_token&gt;</span></span><br><span class="line">    <span class="attr">room_id:</span> <span class="number">85</span></span><br><span class="line">    <span class="attr">message_format:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>通过上面的配置文件实例大概就可以了解了alertManager的功能和使用方法。</p>
<p><code>global</code>是用于设置一些全局的默认配置。</p>
<p><code>template</code>是用于设置发送发送给接受者的消息格式，它使用了Go语言的模板引擎。</p>
<p><code>receiver</code>是alert消息的接收者，现在alertManger可以设置<code>webhook</code>,<code>e-mail</code>和<code>Slack</code>接收者。</p>
<p><code>inhibit_rules</code>是一些静默规则，用于当某些alert生效时，把其他的alert静默掉。</p>
<p><code>routes</code>是比较重要的配置， 它把特定的alert发送给指定的接收者。<br>它的数据结构是一棵树，当子节点的配置项会继承父节点的配置项。当alert发生时，它会从路由树的根节点进入，根节点必须是能够匹配所有alert。相当于是默认节点，保证至少有一个接收者会处理alert.接着它会遍历子节点，根据配置项<code>continue</code>的不同，它在发现了一个匹配项后，会立即返回(true)或者继续遍历(false).</p>
<p>它的匹配方法是根据metrics的标签进行精确匹配(match)或者正则匹配(match_re)。</p>
<p>另外，值得注意的是它消除重复alert的方式。为了避免同类型的错误重复告警，alertManager按组的方式管理alert的。分组的方式也是使用label,<code>group_by</code>配置项指定根据哪些label进行分组，如果这些label相同，那么alert就会分到同一组里面。</p>
<p>除了分组外，alertManager还通过限定同一组alert的发送间隔来避免重复告警。相关的配置项有3个，很容易混淆，所以我具体地接受一些：</p>
<p><code>group_wait</code>:alert一般不是同时发生的，为了让符合条件的alert分到同一组，就需要让最先到的alert等待一段时间，这段时间就是<code>group_wait</code>,<code>group_wait</code>后才发送一组alert.</p>
<p><code>group_interval</code>:再发送一组alert后，如果有新的alert进入到同一组中，新的alert就需要等待<code>group_interval</code>的时间。</p>
<p><code>repeat_interval</code>:即使没有新的alert进来，旧的那组alert也会在<code>repeat_interval</code>后重新发送。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Prometheus的alert管理并非十分复杂，通过它的配置文件我们就能基本了解它的功能和原理。但它有些配置项容易混淆，这些就需要仔细区分了。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">方镇澎</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://fzp.github.io/2019/11/18/2019-11-19-prometheus-alert/">http://fzp.github.io/2019/11/18/2019-11-19-prometheus-alert/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/alert/">alert</a><a class="post-meta__tags" href="/tags/Prometheus/">Prometheus</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/03/09/2020-3-10-compute-quantile/"><i class="fa fa-chevron-left">  </i><span>How to compute quantile effeciently</span></a></div><div class="next-post pull-right"><a href="/2019/11/14/2019-11-15-ssh-proxy-port-forwarding/"><span>SSH 跳板机和隧道</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By 方镇澎</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.3"></script><script src="/js/fancybox.js?version=1.9.3"></script><script src="/js/sidebar.js?version=1.9.3"></script><script src="/js/copy.js?version=1.9.3"></script><script src="/js/fireworks.js?version=1.9.3"></script><script src="/js/transition.js?version=1.9.3"></script><script src="/js/scroll.js?version=1.9.3"></script><script src="/js/head.js?version=1.9.3"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>